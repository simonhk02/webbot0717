<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>WhatsApp æ©Ÿæ¢°äººè¨­ç½®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* å„ªåŒ–çš„æ¨£å¼ç³»çµ± */
    :root {
      --primary-color: #10b981;
      --primary-dark: #059669;
      --secondary-color: #3b82f6;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --success-color: #10b981;
      --bg-dark: #111827;
      --bg-card: #1f2937;
      --text-primary: #f9fafb;
      --text-secondary: #d1d5db;
      --border-color: #374151;
    }

    /* å‹•ç•«å’Œäº’å‹•æ•ˆæœ */
    .animate-pulse-soft {
      animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse-soft {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .animate-bounce-in {
      animation: bounce-in 0.5s ease-out;
    }
    
    @keyframes bounce-in {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .animate-slide-in {
      animation: slide-in 0.3s ease-out;
    }
    
    @keyframes slide-in {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* é€²åº¦æ¢æ¨£å¼ */
    .progress-bar {
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--primary-color));
      background-size: 200% 100%;
      animation: progress-shimmer 2s linear infinite;
    }
    
    @keyframes progress-shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
    .status-indicator {
      position: relative;
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-indicator.online {
      background-color: var(--success-color);
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
    }
    
    .status-indicator.offline {
      background-color: var(--danger-color);
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
    }
    
    .status-indicator.connecting {
      background-color: var(--warning-color);
      animation: pulse 1.5s infinite;
    }

    /* å¢å¼·çš„æŒ‰éˆ•æ¨£å¼ */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .btn-primary.loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: loading-shimmer 1.5s infinite;
    }
    
    @keyframes loading-shimmer {
      100% { left: 100%; }
    }

    /* å¢å¼·çš„å¡ç‰‡æ•ˆæœ */
    .card-enhanced {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .card-enhanced:hover {
      border-color: var(--primary-color);
      box-shadow: 0 8px 32px rgba(16, 185, 129, 0.1);
    }

    /* é€šçŸ¥æ¨£å¼ */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 400px;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }

    /* æ¥µè‡´ç§»å‹•ç«¯å„ªåŒ– */
    @media (max-width: 640px) {
      .mobile-padding { padding: 1rem; }
      .mobile-text { font-size: 0.875rem; }
      .mobile-input { font-size: 16px; }
      .mobile-button { padding: 0.75rem 1rem; width: 100%; margin-bottom: 0.5rem; }
      .mobile-container { margin: 0; border-radius: 0; }
      .mobile-header { padding: 0.75rem; }
      .mobile-section { padding: 1rem; }
      
      .notification {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
      }
      
      .notification.show {
        transform: translateX(0);
      }
      
      /* æ‰‹æ©Ÿå°ˆç”¨å¿«æ·æ“ä½œå€ */
      .mobile-quick-actions {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
      }
      
      .quick-action-btn {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        margin-bottom: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }
      
      .quick-action-btn:active {
        transform: scale(0.95);
      }
      
      /* æ‰‹å‹¢æ”¯æŒ */
      .swipe-container {
        touch-action: pan-y;
        overflow-x: hidden;
      }
      
      /* å¤§æ‹‡æŒ‡å‹å¥½çš„æŒ‰éˆ• */
      .thumb-friendly {
        min-height: 48px;
        min-width: 48px;
      }
      
      /* ä¸€éµæ¨¡æ¿ */
      .template-card {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      
      .template-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
      }
      
      .template-card:hover::before {
        left: 100%;
      }
      
      .template-card:active {
        transform: scale(0.98);
      }
    }

    /* è§¸æ‘¸åé¥‹ */
    .touch-feedback {
      -webkit-tap-highlight-color: rgba(16, 185, 129, 0.3);
      user-select: none;
    }
    
    /* éœ‡å‹•åé¥‹æ¨£å¼ */
    .vibrate-on-touch:active {
      animation: vibrate 0.1s;
    }
    
    @keyframes vibrate {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-1px); }
      75% { transform: translateX(1px); }
    }
    
    /* æ»‘å…¥å‹•ç•« */
    .animate-slide-up {
      animation: slide-up 0.3s ease-out;
    }
    
    @keyframes slide-up {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-color);
    }
  </style>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100">
  <!-- é€šçŸ¥ç³»çµ± -->
  <div id="notification" class="notification">
    <div class="bg-white rounded-lg shadow-lg p-4 border-l-4" id="notificationContent">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <i id="notificationIcon" class="fas fa-info-circle text-blue-500"></i>
        </div>
        <div class="ml-3">
          <p id="notificationMessage" class="text-sm font-medium text-gray-900"></p>
        </div>
        <button id="notificationClose" class="ml-auto flex-shrink-0 text-gray-400 hover:text-gray-600 thumb-friendly touch-feedback">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- ç§»å‹•ç«¯å¿«æ·æ“ä½œå€ -->
  <div id="mobileQuickActions" class="mobile-quick-actions block sm:hidden">
    <button id="quickSave" class="quick-action-btn bg-green-500 text-white flex items-center justify-center touch-feedback vibrate-on-touch" title="å¿«é€Ÿä¿å­˜">
      <i class="fas fa-save text-lg"></i>
    </button>
    <button id="quickTest" class="quick-action-btn bg-blue-500 text-white flex items-center justify-center touch-feedback vibrate-on-touch" title="æ¸¬è©¦é€£æ¥">
      <i class="fas fa-plug text-lg"></i>
    </button>
    <button id="quickTemplate" class="quick-action-btn bg-purple-500 text-white flex items-center justify-center touch-feedback vibrate-on-touch" title="å¿«é€Ÿæ¨¡æ¿">
      <i class="fas fa-magic text-lg"></i>
    </button>
  </div>

  <!-- å¿«é€Ÿæ¨¡æ¿é¸æ“‡å™¨ -->
  <div id="templateModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-end justify-center min-h-screen p-4">
      <div class="bg-white rounded-t-3xl w-full max-w-md animate-slide-up">
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900">é¸æ“‡å¿«é€Ÿæ¨¡æ¿</h3>
            <button id="closeTemplateModal" class="text-gray-400 hover:text-gray-600 thumb-friendly">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <div class="space-y-3" id="templateList">
            <!-- æ¨¡æ¿å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸»å®¹å™¨ -->
  <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    <div class="card-enhanced rounded-2xl shadow-2xl overflow-hidden mobile-container">
      <!-- å¢å¼·çš„é ‚éƒ¨å°èˆªæ¬„ -->
      <div class="px-6 py-4 mobile-header bg-gradient-to-r from-gray-800 to-gray-700">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="relative">
              <i class="fas fa-robot text-2xl sm:text-3xl text-green-400"></i>
              <div id="connectionStatus" class="status-indicator connecting absolute -top-1 -right-1"></div>
            </div>
            <div>
              <h1 class="text-xl sm:text-2xl font-bold text-white">WhatsApp æ©Ÿæ¢°äººæ§åˆ¶å°</h1>
              <p id="statusText" class="text-sm text-gray-400">æ­£åœ¨é€£æ¥...</p>
            </div>
          </div>
          <button id="logout" class="btn-primary px-3 sm:px-4 py-2 rounded-lg text-white transition-all mobile-button">
            <i class="fas fa-sign-out-alt mr-2"></i>
            <span class="hidden sm:inline">ç™»å‡º</span>
          </button>
        </div>
      </div>

      <!-- é€²åº¦æ¢ -->
      <div id="progressBar" class="hidden">
        <div class="progress-bar h-1"></div>
      </div>

      <!-- éŒ¯èª¤æç¤º (ä¿ç•™åŸæœ‰åŠŸèƒ½ï¼Œä½†æ¨£å¼å„ªåŒ–) -->
      <div id="error" class="hidden px-4 sm:px-6 py-3 bg-red-500/20 text-red-300 mobile-text animate-slide-in"></div>

      <!-- å¢å¼·çš„ QR ç¢¼éƒ¨åˆ† -->
      <div id="qrSection" class="p-4 sm:p-6 border-b border-gray-700 mobile-section">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-200 mb-4 flex items-center">
          <i class="fas fa-qrcode mr-2 text-green-400"></i>ç¶å®š WhatsApp
          <span id="qrStatus" class="ml-2 text-sm text-gray-400"></span>
        </h2>
        
        <div id="qrContainer" class="hidden text-center">
          <div class="animate-bounce-in">
            <p class="text-gray-400 mb-4 mobile-text">è«‹ä½¿ç”¨ WhatsApp æƒæä»¥ä¸‹ QR ç¢¼ä»¥ç¶å®šä½ çš„å¸³è™Ÿ</p>
            <div class="inline-block p-4 rounded-xl bg-white">
              <img id="qrCode" src="" alt="QR Code" class="w-48 h-48 sm:w-64 sm:h-64">
            </div>
            <div class="mt-4 flex items-center justify-center space-x-4">
              <button id="refreshQR" class="px-4 py-2 text-sm text-green-400 hover:text-green-300 transition-colors">
                <i class="fas fa-refresh mr-2"></i>é‡æ–°ç”Ÿæˆ
              </button>
              <div class="text-sm text-gray-500">
                <i class="fas fa-clock mr-1"></i>
                <span id="qrTimer">ç­‰å¾…æƒæ...</span>
              </div>
            </div>
          </div>
        </div>
        
        <div id="loadingContainer" class="text-center">
          <div class="inline-block rounded-full h-10 w-10 sm:h-12 sm:w-12 border-4 border-green-400 border-t-transparent animate-spin"></div>
          <p class="mt-4 text-gray-400 mobile-text animate-pulse-soft">æ­£åœ¨åˆå§‹åŒ– WhatsApp å®¢æˆ¶ç«¯ï¼Œè«‹ç¨å€™...</p>
          <div class="mt-2 text-xs text-gray-500">
            <span id="loadingStatus">é€£æ¥ä¸­...</span>
          </div>
        </div>
      </div>

      <!-- å¢å¼·çš„è¨­ç½®éƒ¨åˆ† -->
      <div class="p-4 sm:p-6 mobile-section">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg sm:text-xl font-semibold text-gray-200 flex items-center">
            <i class="fas fa-cogs mr-2 text-green-400"></i>ç³»çµ±è¨­ç½®
          </h2>
          <div class="flex items-center space-x-2">
            <div id="saveStatus" class="text-sm text-gray-500 hidden">
              <i class="fas fa-save mr-1"></i>å·²å„²å­˜
            </div>
            <button id="testConnection" class="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 rounded-md text-white transition-colors">
              <i class="fas fa-plug mr-1"></i>æ¸¬è©¦é€£æ¥
            </button>
          </div>
        </div>
        
        <!-- å¢å¼·çš„åˆ†é å°èˆª -->
        <div class="mb-6 border-b border-gray-700">
          <nav class="flex space-x-4" aria-label="Tabs">
            <button id="generalTab" class="tab-button px-4 py-2 text-sm font-medium text-green-400 border-b-2 border-green-400 transition-all">
              <i class="fas fa-sliders-h mr-2"></i>ä¸€èˆ¬è¨­å®š
            </button>
            <button id="analyticsTab" class="tab-button px-4 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent transition-all">
              <i class="fas fa-chart-bar mr-2"></i>AIæ™ºèƒ½å„€è¡¨æ¿
            </button>
            <button id="pdfTemplateTab" class="tab-button px-4 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent transition-all">
              <i class="fas fa-file-pdf mr-2"></i>PDF ç™¼ç¥¨æ¨¡ç‰ˆ
            </button>
            <button id="advancedTab" class="tab-button px-4 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent transition-all">
              <i class="fas fa-tools mr-2"></i>é€²éšè¨­å®š
            </button>
          </nav>
        </div>
        <!-- ä¸€èˆ¬è¨­å®šåˆ†é  -->
        <div id="generalSettings" class="space-y-6">
          <!-- é€£æ¥ç‹€æ…‹å¡ç‰‡ -->
          <div class="card-enhanced p-4 rounded-xl">
            <h3 class="text-md font-medium text-gray-300 mb-4 flex items-center">
              <i class="fas fa-wifi mr-2 text-green-400"></i>é€£æ¥ç‹€æ…‹
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div class="text-center p-3 bg-gray-800/30 rounded-lg">
                <div id="whatsappStatus" class="status-indicator connecting mx-auto mb-2"></div>
                <p class="text-xs text-gray-400">WhatsApp</p>
                <p id="whatsappStatusText" class="text-sm font-medium">é€£æ¥ä¸­</p>
              </div>
              <div class="text-center p-3 bg-gray-800/30 rounded-lg">
                <div id="googleStatus" class="status-indicator connecting mx-auto mb-2"></div>
                <p class="text-xs text-gray-400">Google æœå‹™</p>
                <p id="googleStatusText" class="text-sm font-medium">æª¢æŸ¥ä¸­</p>
              </div>
              <div class="text-center p-3 bg-gray-800/30 rounded-lg">
                <div id="aiStatus" class="status-indicator connecting mx-auto mb-2"></div>
                <p class="text-xs text-gray-400">AI æœå‹™</p>
                <p id="aiStatusText" class="text-sm font-medium">æª¢æŸ¥ä¸­</p>
              </div>
            </div>
          </div>

          <!-- æ™ºèƒ½å¿«é€Ÿè¨­å®šæ¨¡æ¿ -->
          <div class="card-enhanced p-4 rounded-xl mb-6">
            <h3 class="text-md font-medium text-gray-300 mb-4 flex items-center">
              <i class="fas fa-magic mr-2 text-purple-400"></i>ä¸€éµå¿«é€Ÿè¨­å®š
              <span class="ml-2 text-xs bg-purple-500 text-white px-2 py-1 rounded-full">æ–°åŠŸèƒ½</span>
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div class="template-card touch-feedback" data-template="personal">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="font-semibold">å€‹äººè¨˜å¸³</h4>
                    <p class="text-sm opacity-90">é©åˆå€‹äººæ—¥å¸¸é–‹æ”¯è¨˜éŒ„</p>
                  </div>
                  <i class="fas fa-user text-2xl opacity-75"></i>
                </div>
              </div>
              <div class="template-card touch-feedback" data-template="business">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="font-semibold">å•†æ¥­å ±éŠ·</h4>
                    <p class="text-sm opacity-90">ä¼æ¥­å“¡å·¥å ±éŠ·ç®¡ç†</p>
                  </div>
                  <i class="fas fa-building text-2xl opacity-75"></i>
                </div>
              </div>
              <div class="template-card touch-feedback" data-template="family">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="font-semibold">å®¶åº­å…±ç”¨</h4>
                    <p class="text-sm opacity-90">å®¶åº­æˆå“¡å…±åŒè¨˜å¸³</p>
                  </div>
                  <i class="fas fa-home text-2xl opacity-75"></i>
                </div>
              </div>
              <div class="template-card touch-feedback" data-template="travel">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="font-semibold">æ—…éŠè¨˜å¸³</h4>
                    <p class="text-sm opacity-90">æ—…è¡Œé–‹æ”¯è¿½è¹¤</p>
                  </div>
                  <i class="fas fa-plane text-2xl opacity-75"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- ç¾¤çµ„è¨­ç½® -->
          <div class="card-enhanced p-4 rounded-xl">
            <h3 class="text-md font-medium text-gray-300 mb-4 flex items-center">
              <i class="fas fa-users mr-2 text-green-400"></i>WhatsApp ç¾¤çµ„è¨­å®š
            </h3>
            <div class="space-y-4">
              <div>
                <label for="groupName" class="block text-sm font-medium text-gray-300 mb-2">ç¾¤çµ„åç¨±</label>
                <div class="relative">
                  <input type="text" id="groupName" 
                         class="w-full px-3 sm:px-4 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input pr-10 touch-feedback"
                         placeholder="è¼¸å…¥ç¾¤çµ„åç¨±">
                  <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                    <i id="groupNameStatus" class="fas fa-check text-green-400 hidden"></i>
                  </div>
                </div>
                <p class="mt-1 text-xs text-gray-500">æ©Ÿæ¢°äººåªæœƒåœ¨æ­¤ç¾¤çµ„ä¸­å›æ‡‰æ¶ˆæ¯</p>
              </div>
            </div>
          </div>
        <!-- AI åŠŸèƒ½è¨­å®š -->
        <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-xl">
          <h3 class="text-md font-medium text-gray-300 mb-4">AI åœ–ç‰‡è­˜åˆ¥åŠŸèƒ½</h3>
          <div class="space-y-4">
            <label class="flex items-center justify-between cursor-pointer select-none">
              <span class="text-sm font-medium text-gray-300">å•Ÿç”¨ AI åœ–ç‰‡è­˜åˆ¥</span>
              <span class="relative inline-block w-12 h-6">
                <input type="checkbox" id="enableAI" class="sr-only">
                <span class="block w-12 h-6 bg-gray-700 rounded-full"></span>
                <span id="aiDot" class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform duration-200 ease-in-out"></span>
              </span>
            </label>
            <div id="aiSettings" class="space-y-4 hidden">
              <div>
                <label for="aiConfidenceThreshold" class="block text-sm font-medium text-gray-300 mb-2">AI è­˜åˆ¥å¯ä¿¡åº¦é–¾å€¼</label>
                <div class="flex items-center space-x-4">
                  <input type="range" id="aiConfidenceThreshold" min="0" max="100" step="1"
                         class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                  <span id="aiConfidenceValue" class="text-sm text-gray-300 w-12 text-right">80%</span>
                </div>
                <p class="mt-1 text-xs text-gray-400">ç•¶ AI è­˜åˆ¥çµæœçš„å¯ä¿¡åº¦ä½æ–¼æ­¤å€¼æ™‚ï¼Œç³»çµ±æœƒè¦æ±‚æ‚¨ç¢ºèª</p>
              </div>
            </div>
          </div>
        </div>
        <!-- æ™ºèƒ½è¨Šæ¯æ ¼å¼è¨­å®š -->
        <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-xl card-enhanced">
          <div class="flex items-center justify-between mb-3">
            <label for="messageFormat" class="block text-sm font-medium text-gray-300">ç™¼é€æ ¼å¼</label>
            <div class="flex space-x-2">
              <button id="formatHelper" class="px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 rounded text-white touch-feedback" title="æ ¼å¼åŠ©æ‰‹">
                <i class="fas fa-question-circle mr-1"></i>åŠ©æ‰‹
              </button>
              <button id="previewFormat" class="px-2 py-1 text-xs bg-green-600 hover:bg-green-700 rounded text-white touch-feedback" title="é è¦½æ ¼å¼">
                <i class="fas fa-eye mr-1"></i>é è¦½
              </button>
            </div>
          </div>
          <div class="relative">
            <textarea id="messageFormat" rows="4" 
                      class="w-full px-3 sm:px-4 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input touch-feedback"
                      placeholder="æ—¥æœŸ: {date}&#10;é …ç›®: {item}&#10;éŠ€ç¢¼: ${amount}&#10;å‚™è¨»: {note}&#10;æ”¶æ“š: {imageUrl}"></textarea>
            <div class="absolute bottom-2 right-2">
              <button id="insertVariable" class="text-gray-400 hover:text-green-400 text-sm touch-feedback" title="æ’å…¥è®Šæ•¸">
                <i class="fas fa-plus-circle"></i>
              </button>
            </div>
          </div>
          <div class="mt-2 flex flex-wrap gap-1">
            <span class="inline-block px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded cursor-pointer hover:bg-green-600 touch-feedback" data-variable="{date}">æ—¥æœŸ</span>
            <span class="inline-block px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded cursor-pointer hover:bg-green-600 touch-feedback" data-variable="{item}">é …ç›®</span>
            <span class="inline-block px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded cursor-pointer hover:bg-green-600 touch-feedback" data-variable="{amount}">é‡‘é¡</span>
            <span class="inline-block px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded cursor-pointer hover:bg-green-600 touch-feedback" data-variable="{note}">å‚™è¨»</span>
            <span class="inline-block px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded cursor-pointer hover:bg-green-600 touch-feedback" data-variable="{imageUrl}">æ”¶æ“š</span>
          </div>
        </div>
        <!-- Google Drive è¨­ç½® -->
        <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-xl">
          <label for="driveFolderUrl" class="block text-sm font-medium text-gray-300 mb-2">Google Drive æ–‡ä»¶å¤¾ URL</label>
          <input type="text" id="driveFolderUrl" 
                 class="w-full px-3 sm:px-4 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                 placeholder="è¼¸å…¥ Google Drive æ–‡ä»¶å¤¾ URL">
          <p class="mt-1 text-xs sm:text-sm text-gray-400">å¦‚ä½•ç²å–ï¼šæ‰“é–‹ Google Driveï¼Œå‰µå»ºä¸€å€‹è³‡æ–™å¤¾ï¼Œè¤‡è£½ URL ä¸­çš„ Folder ID</p>
        </div>
        <!-- Google Sheet è¨­ç½® -->
        <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-xl">
          <label for="sheetUrl" class="block text-sm font-medium text-gray-300 mb-2">Google Sheet URL</label>
          <input type="text" id="sheetUrl" 
                 class="w-full px-3 sm:px-4 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                 placeholder="è¼¸å…¥ Google Sheet URL">
          <p class="mt-1 text-xs sm:text-sm text-gray-400">å¦‚ä½•ç²å–ï¼šæ‰“é–‹ Google Sheetï¼Œè¤‡è£½ URL ä¸­çš„ Sheet ID</p>
        </div>
        <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-xl">
          <label for="sheetName" class="block text-sm font-medium text-gray-300 mb-2">Google Sheet å·¥ä½œè¡¨åç¨±</label>
          <input type="text" id="sheetName" 
                 class="w-full px-3 sm:px-4 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                 placeholder="è¼¸å…¥å·¥ä½œè¡¨åç¨±">
        </div>
        <!-- è‡ªè¨‚å•é¡Œ -->
        <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-xl">
          <label class="block text-sm font-medium text-gray-300 mb-2">è‡ªè¨‚å•é¡Œ</label>
          <div id="customQuestions" class="space-y-3 sm:space-y-4"></div>
          <button id="addQuestion" 
                  class="mt-4 px-4 py-2 text-gray-300 rounded-lg hover:bg-white/10 transition-all touch-feedback w-full sm:w-auto">
            <i class="fas fa-plus mr-2"></i>æ–°å¢å•é¡Œ
          </button>
        </div>
        </div>

        <!-- AIæ™ºèƒ½å„€è¡¨æ¿åˆ†é  -->
        <div id="analyticsSettings" class="space-y-6 hidden">
          <!-- å„€è¡¨æ¿å…¥å£å¡ç‰‡ -->
          <div class="card-enhanced p-6 rounded-xl bg-gradient-to-br from-purple-900/30 to-blue-900/30 border border-purple-500/20">
            <div class="text-center">
              <div class="mb-4">
                <i class="fas fa-chart-line text-4xl text-purple-400 mb-2"></i>
                <h3 class="text-xl font-bold text-white mb-2">AI æ™ºèƒ½å„€è¡¨æ¿</h3>
                <p class="text-gray-300 text-sm">
                  ä½¿ç”¨ Claude 3 Haiku AI è‡ªå‹•åˆ†ææ‚¨çš„è²»ç”¨æ•¸æ“šï¼Œ<br>
                  ç”Ÿæˆå€‹æ€§åŒ–çš„å¯è¦–åŒ–åœ–è¡¨å’Œæ™ºèƒ½æ´å¯Ÿ
                </p>
              </div>
              
              <div class="mb-6">
                <button id="openAnalytics" class="btn-primary px-8 py-4 rounded-xl text-white font-semibold text-lg hover:scale-105 transform transition-all duration-300 shadow-lg">
                  <i class="fas fa-rocket mr-3"></i>
                  å•Ÿå‹•æ™ºèƒ½å„€è¡¨æ¿
                </button>
              </div>
              
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                <div class="bg-white/5 rounded-lg p-3">
                  <i class="fas fa-brain text-blue-400 mb-2"></i>
                  <p class="text-gray-300">AI è‡ªå‹•åˆ†æ</p>
                </div>
                <div class="bg-white/5 rounded-lg p-3">
                  <i class="fas fa-chart-pie text-green-400 mb-2"></i>
                  <p class="text-gray-300">å¤šç¨®åœ–è¡¨é¡å‹</p>
                </div>
                <div class="bg-white/5 rounded-lg p-3">
                  <i class="fas fa-lightbulb text-yellow-400 mb-2"></i>
                  <p class="text-gray-300">æ™ºèƒ½æ´å¯Ÿå»ºè­°</p>
                </div>
              </div>
            </div>
          </div>

          <!-- åŠŸèƒ½èªªæ˜ -->
          <div class="card-enhanced p-4 rounded-xl">
            <h4 class="text-lg font-semibold text-gray-200 mb-4 flex items-center">
              <i class="fas fa-info-circle mr-2 text-blue-400"></i>
              åŠŸèƒ½ç‰¹è‰²
            </h4>
            <div class="space-y-3">
              <div class="flex items-start space-x-3">
                <i class="fas fa-check-circle text-green-400 mt-0.5"></i>
                <div>
                  <p class="text-gray-300 font-medium">å®Œå…¨è‡ªé©æ‡‰åˆ†æ</p>
                  <p class="text-gray-400 text-sm">AI è‡ªå‹•è­˜åˆ¥æ‚¨çš„æ•¸æ“šçµæ§‹ï¼Œç„¡éœ€æ‰‹å‹•é…ç½®æ¬„ä½</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <i class="fas fa-check-circle text-green-400 mt-0.5"></i>
                <div>
                  <p class="text-gray-300 font-medium">æ™ºèƒ½åœ–è¡¨æ¨è–¦</p>
                  <p class="text-gray-400 text-sm">æ ¹æ“šæ•¸æ“šç‰¹å¾µè‡ªå‹•æ¨è–¦æœ€é©åˆçš„è¦–è¦ºåŒ–åœ–è¡¨</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <i class="fas fa-check-circle text-green-400 mt-0.5"></i>
                <div>
                  <p class="text-gray-300 font-medium">å€‹æ€§åŒ–æ´å¯Ÿ</p>
                  <p class="text-gray-400 text-sm">AI åˆ†ææ‚¨çš„æ¶ˆè²»æ¨¡å¼ï¼Œæä¾›ç¯€çœå»ºè­°å’Œè¶¨å‹¢é æ¸¬</p>
                </div>
              </div>
              <div class="flex items-start space-x-3">
                <i class="fas fa-check-circle text-green-400 mt-0.5"></i>
                <div>
                  <p class="text-gray-300 font-medium">å¯¦æ™‚æ•¸æ“šæ›´æ–°</p>
                  <p class="text-gray-400 text-sm">æ”¯æŒæ•¸æ“šè®ŠåŒ–æ™‚è‡ªå‹•é‡æ–°åˆ†æå’Œæ›´æ–°åœ–è¡¨</p>
                </div>
              </div>
            </div>
          </div>

          <!-- æ•¸æ“šè¦æ±‚èªªæ˜ -->
          <div class="card-enhanced p-4 rounded-xl border border-yellow-500/20 bg-yellow-900/10">
            <h4 class="text-lg font-semibold text-yellow-200 mb-3 flex items-center">
              <i class="fas fa-exclamation-triangle mr-2 text-yellow-400"></i>
              ä½¿ç”¨å‰æ
            </h4>
            <div class="text-sm text-yellow-100 space-y-2">
              <p>â€¢ ç¢ºä¿å·²é…ç½® Google Sheets ä¸¦æœ‰è²»ç”¨æ•¸æ“š</p>
              <p>â€¢ AI éœ€è¦è‡³å°‘ 5-10 ç­†æ•¸æ“šæ‰èƒ½é€²è¡Œæœ‰æ•ˆåˆ†æ</p>
              <p>â€¢ å»ºè­°æ•¸æ“šåŒ…å«æ—¥æœŸã€é‡‘é¡ã€é …ç›®ç­‰åŸºæœ¬æ¬„ä½</p>
              <p>â€¢ é¦–æ¬¡åˆ†æå¯èƒ½éœ€è¦ 10-30 ç§’æ™‚é–“</p>
            </div>
          </div>
        </div>

        <!-- PDF ç™¼ç¥¨æ¨¡ç‰ˆåˆ†é  -->
        <div id="pdfTemplateSettings" class="space-y-4 hidden">
          <!-- å…¬å¸è³‡è¨Š -->
          <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-xl">
            <h3 class="text-md font-medium text-gray-300 mb-4">å…¬å¸è³‡è¨Š</h3>
            <div class="space-y-4">
              <div>
                <label for="companyName" class="block text-sm font-medium text-gray-300 mb-2">å…¬å¸åç¨±</label>
                <input type="text" id="companyName" 
                       class="w-full px-3 sm:px-4 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                       placeholder="è¼¸å…¥å…¬å¸åç¨±"
                       onchange="updateCompanyName(this.value)">
              </div>
              <div>
                <label for="companyAddress" class="block text-sm font-medium text-gray-300 mb-2">å…¬å¸åœ°å€</label>
                <textarea id="companyAddress" rows="2"
                          class="w-full px-3 sm:px-4 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                          placeholder="è¼¸å…¥å…¬å¸åœ°å€"
                          onchange="updateCompanyAddress(this.value)"></textarea>
              </div>
              <div>
                <label for="companyPhone" class="block text-sm font-medium text-gray-300 mb-2">å…¬å¸é›»è©±</label>
                <input type="text" id="companyPhone" 
                       class="w-full px-3 sm:px-4 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                       placeholder="è¼¸å…¥å…¬å¸é›»è©±"
                       onchange="updateCompanyPhone(this.value)">
              </div>
            </div>
          </div>
          <!-- ç™¼ç¥¨æ¨¡ç‰ˆè¨­å®š -->
          <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-xl">
            <h3 class="text-md font-medium text-gray-300 mb-4">ç™¼ç¥¨æ¨¡ç‰ˆè¨­å®š</h3>
            <div class="space-y-4">
              <div>
                <label for="invoiceTitle" class="block text-sm font-medium text-gray-300 mb-2">ç™¼ç¥¨æ¨™é¡Œ</label>
                <input type="text" id="invoiceTitle" 
                       class="w-full px-3 sm:px-4 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                       placeholder="è¼¸å…¥ç™¼ç¥¨æ¨™é¡Œ"
                       onchange="updateInvoiceTitle(this.value)">
              </div>
              <div>
                <label for="invoiceNumberPrefix" class="block text-sm font-medium text-gray-300 mb-2">ç™¼ç¥¨ç·¨è™Ÿå‰ç¶´</label>
                <input type="text" id="invoiceNumberPrefix" 
                       class="w-full px-3 sm:px-4 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                       placeholder="ä¾‹å¦‚ï¼šINV-"
                       onchange="updateInvoiceNumberPrefix(this.value)">
              </div>
              <div>
                <label for="invoiceFooter" class="block text-sm font-medium text-gray-300 mb-2">ç™¼ç¥¨é å°¾</label>
                <textarea id="invoiceFooter" rows="2"
                          class="w-full px-3 sm:px-4 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                          placeholder="è¼¸å…¥ç™¼ç¥¨é å°¾æ–‡å­—"
                          onchange="updateInvoiceFooter(this.value)"></textarea>
              </div>
            </div>
          </div>
          <!-- ç™¼ç¥¨é …ç›®è¨­å®š -->
          <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-xl">
            <h3 class="text-md font-medium text-gray-300 mb-4">ç™¼ç¥¨é …ç›®è¨­å®š</h3>
            <div id="invoiceFieldsList" class="space-y-3"></div>
            <button id="addInvoiceField" class="mt-4 px-4 py-2 text-gray-300 rounded-lg hover:bg-white/10 transition-all touch-feedback w-full sm:w-auto">
              <i class="fas fa-plus mr-2"></i>æ–°å¢ç™¼ç¥¨æ¬„ä½
            </button>
          </div>
          <!-- é è¦½å€åŸŸ -->
          <div class="mb-4 sm:mb-6 p-3 sm:p-4 rounded-xl">
            <h3 class="text-md font-medium text-gray-300 mb-4">é è¦½</h3>
            <div id="pdfPreview" class="bg-white p-4 rounded-lg min-h-[400px]">
              <!-- é è¦½å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
          </div>
        </div>
        <!-- å„²å­˜æŒ‰éˆ• -->
        <div class="flex flex-col sm:flex-row sm:justify-end space-y-2 sm:space-y-0 sm:space-x-2">
          <button id="saveSettings" 
                  class="px-6 py-2 text-white rounded-lg hover:bg-opacity-90 transition-all glow touch-feedback mobile-button">
            <i class="fas fa-save mr-2"></i>å„²å­˜è¨­ç½®
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€è®Šæ•¸
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    let qrTimer = null;
    let qrCountdown = 0;
    let autoSaveTimer = null;
    
    if (!userId) {
      showNotification('ç¼ºå°‘ userIdï¼Œç„¡æ³•è¼‰å…¥è¨­ç½®é é¢', 'error');
      setTimeout(() => window.location.href = '/', 2000);
    }

    // ç§»å‹•ç«¯å¢å¼·åŠŸèƒ½
    const isMobile = window.innerWidth <= 640;
    
    // éœ‡å‹•åé¥‹åŠŸèƒ½
    function vibrate(pattern = [50]) {
      if ('vibrate' in navigator && isMobile) {
        navigator.vibrate(pattern);
      }
    }
    
    // è§¸æ‘¸åé¥‹
    document.addEventListener('touchstart', function(e) {
      if (e.target.classList.contains('vibrate-on-touch')) {
        vibrate([25]);
      }
    });

    // å¿«é€Ÿæ¨¡æ¿é…ç½®
    const templates = {
      personal: {
        name: 'å€‹äººè¨˜å¸³',
        groupName: 'æˆ‘çš„è¨˜å¸³ç¾¤çµ„',
        messageFormat: 'ğŸ“… æ—¥æœŸ: {date}\nğŸ’° é …ç›®: {item}\nğŸ’µ é‡‘é¡: ${amount}\nğŸ“ å‚™è¨»: {note}\nğŸ“¸ æ”¶æ“š: {imageUrl}',
        customQuestions: [
          { question: 'é€™ç­†è²»ç”¨çš„é¡åˆ¥æ˜¯ä»€éº¼ï¼Ÿ', field: 'category' },
          { question: 'ä»˜æ¬¾æ–¹å¼ï¼Ÿ', field: 'paymentMethod' }
        ]
      },
      business: {
        name: 'å•†æ¥­å ±éŠ·',
        groupName: 'å…¬å¸å ±éŠ·ç¾¤çµ„',
        messageFormat: 'ğŸ¢ å ±éŠ·å–®\nğŸ“… æ—¥æœŸ: {date}\nğŸ“‹ é …ç›®: {item}\nğŸ’° é‡‘é¡: ${amount}\nğŸ‘¤ ç”³è«‹äºº: {requester}\nğŸ“ ç”¨é€”: {note}\nğŸ“¸ æ”¶æ“š: {imageUrl}',
        customQuestions: [
          { question: 'ç”³è«‹äººå§“åï¼Ÿ', field: 'requester' },
          { question: 'è²»ç”¨é¡åˆ¥ï¼Ÿ', field: 'category' },
          { question: 'éƒ¨é–€ï¼Ÿ', field: 'department' }
        ]
      },
      family: {
        name: 'å®¶åº­å…±ç”¨',
        groupName: 'å®¶åº­è¨˜å¸³ç¾¤çµ„',
        messageFormat: 'ğŸ  å®¶åº­é–‹æ”¯\nğŸ“… æ—¥æœŸ: {date}\nğŸ›’ é …ç›®: {item}\nğŸ’° é‡‘é¡: ${amount}\nğŸ‘¤ ä»˜æ¬¾äºº: {payer}\nğŸ“ å‚™è¨»: {note}\nğŸ“¸ æ”¶æ“š: {imageUrl}',
        customQuestions: [
          { question: 'èª°ä»˜çš„éŒ¢ï¼Ÿ', field: 'payer' },
          { question: 'æ˜¯å®¶åº­å¿…éœ€å“å—ï¼Ÿ', field: 'necessity' }
        ]
      },
      travel: {
        name: 'æ—…éŠè¨˜å¸³',
        groupName: 'æ—…éŠé–‹æ”¯ç¾¤çµ„',
        messageFormat: 'âœˆï¸ æ—…éŠé–‹æ”¯\nğŸ“… æ—¥æœŸ: {date}\nğŸ¯ é …ç›®: {item}\nğŸ’° é‡‘é¡: ${amount}\nğŸ“ åœ°é»: {location}\nğŸ“ å‚™è¨»: {note}\nğŸ“¸ æ”¶æ“š: {imageUrl}',
        customQuestions: [
          { question: 'åœ¨å“ªå€‹åŸå¸‚/åœ°é»ï¼Ÿ', field: 'location' },
          { question: 'è²»ç”¨é¡å‹ï¼Ÿ(äº¤é€š/ä½å®¿/é¤é£²/æ™¯é»)', field: 'travelType' }
        ]
      }
    };
    
    // é€šçŸ¥ç³»çµ±
    function showNotification(message, type = 'info', duration = 5000) {
      const notification = document.getElementById('notification');
      const icon = document.getElementById('notificationIcon');
      const messageEl = document.getElementById('notificationMessage');
      const content = document.getElementById('notificationContent');
      
      // è¨­ç½®åœ–æ¨™å’Œé¡è‰²
      const config = {
        success: { icon: 'fa-check-circle', color: 'text-green-500', border: 'border-green-500' },
        error: { icon: 'fa-exclamation-circle', color: 'text-red-500', border: 'border-red-500' },
        warning: { icon: 'fa-exclamation-triangle', color: 'text-yellow-500', border: 'border-yellow-500' },
        info: { icon: 'fa-info-circle', color: 'text-blue-500', border: 'border-blue-500' }
      };
      
      const typeConfig = config[type] || config.info;
      icon.className = `fas ${typeConfig.icon} ${typeConfig.color}`;
      content.className = `bg-white rounded-lg shadow-lg p-4 border-l-4 ${typeConfig.border}`;
      messageEl.textContent = message;
      
      // é¡¯ç¤ºé€šçŸ¥
      notification.classList.add('show');
      
      // è‡ªå‹•éš±è—
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }
    
    // é—œé–‰é€šçŸ¥æŒ‰éˆ•
    document.getElementById('notificationClose').addEventListener('click', () => {
      document.getElementById('notification').classList.remove('show');
    });
    
    // é€²åº¦æ¢æ§åˆ¶
    function showProgress() {
      document.getElementById('progressBar').classList.remove('hidden');
    }
    
    function hideProgress() {
      document.getElementById('progressBar').classList.add('hidden');
    }
    
    // ç‹€æ…‹æ›´æ–°å‡½æ•¸
    function updateConnectionStatus() {
      const statusEl = document.getElementById('connectionStatus');
      const statusTextEl = document.getElementById('statusText');
      
      // æª¢æŸ¥å„ç¨®æœå‹™ç‹€æ…‹
      Promise.all([
        checkWhatsAppStatus(),
        checkGoogleStatus(),
        checkAIStatus()
      ]).then(([whatsapp, google, ai]) => {
        if (whatsapp && google && ai) {
          statusEl.className = 'status-indicator online absolute -top-1 -right-1';
          statusTextEl.textContent = 'æ‰€æœ‰æœå‹™æ­£å¸¸';
        } else if (whatsapp) {
          statusEl.className = 'status-indicator connecting absolute -top-1 -right-1';
          statusTextEl.textContent = 'éƒ¨åˆ†æœå‹™é›¢ç·š';
        } else {
          statusEl.className = 'status-indicator offline absolute -top-1 -right-1';
          statusTextEl.textContent = 'é€£æ¥ä¸­æ–·';
        }
      });
    }
    
    // æœå‹™ç‹€æ…‹æª¢æŸ¥å‡½æ•¸
    async function checkWhatsAppStatus() {
      try {
        const response = await fetch(`/api/whatsapp/status?userId=${userId}`);
        const data = await response.json();
        updateServiceStatus('whatsapp', data.loggedIn);
        return data.loggedIn;
      } catch (error) {
        updateServiceStatus('whatsapp', false);
        return false;
      }
    }
    
    async function checkGoogleStatus() {
      try {
        const response = await fetch(`/api/health`);
        const data = await response.json();
        const googleOk = data.googleService === 'healthy';
        updateServiceStatus('google', googleOk);
        return googleOk;
      } catch (error) {
        updateServiceStatus('google', false);
        return false;
      }
    }
    
    async function checkAIStatus() {
      try {
        const response = await fetch(`/api/health`);
        const data = await response.json();
        const aiOk = data.aiService === 'healthy';
        updateServiceStatus('ai', aiOk);
        return aiOk;
      } catch (error) {
        updateServiceStatus('ai', false);
        return false;
      }
    }
    
    function updateServiceStatus(service, isOnline) {
      const statusEl = document.getElementById(`${service}Status`);
      const textEl = document.getElementById(`${service}StatusText`);
      
      if (isOnline) {
        statusEl.className = 'status-indicator online mx-auto mb-2';
        textEl.textContent = 'æ­£å¸¸';
        textEl.className = 'text-sm font-medium text-green-400';
      } else {
        statusEl.className = 'status-indicator offline mx-auto mb-2';
        textEl.textContent = 'é›¢ç·š';
        textEl.className = 'text-sm font-medium text-red-400';
      }
    }
    
    // QR ç¢¼å€’æ•¸è¨ˆæ™‚
    function startQRTimer() {
      qrCountdown = 120; // 2åˆ†é˜
      const timerEl = document.getElementById('qrTimer');
      
      qrTimer = setInterval(() => {
        qrCountdown--;
        const minutes = Math.floor(qrCountdown / 60);
        const seconds = qrCountdown % 60;
        timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} å¾ŒéæœŸ`;
        
        if (qrCountdown <= 0) {
          clearInterval(qrTimer);
          timerEl.textContent = 'QR ç¢¼å·²éæœŸ';
          document.getElementById('refreshQR').classList.remove('hidden');
        }
      }, 1000);
    }
    
    // è‡ªå‹•ä¿å­˜åŠŸèƒ½
    function triggerAutoSave() {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      
      autoSaveTimer = setTimeout(() => {
        saveSettings.click();
      }, 2000);
    }
    
    // æ¸¬è©¦é€£æ¥åŠŸèƒ½
    document.getElementById('testConnection').addEventListener('click', async () => {
      const btn = document.getElementById('testConnection');
      btn.classList.add('loading');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>æ¸¬è©¦ä¸­...';
      
      showProgress();
      vibrate([50, 100, 50]);
      
      try {
        await updateConnectionStatus();
        showNotification('é€£æ¥æ¸¬è©¦å®Œæˆ', 'success');
        vibrate([100]);
      } catch (error) {
        showNotification('é€£æ¥æ¸¬è©¦å¤±æ•—', 'error');
        vibrate([200, 100, 200]);
      } finally {
        btn.classList.remove('loading');
        btn.innerHTML = '<i class="fas fa-plug mr-1"></i>æ¸¬è©¦é€£æ¥';
        hideProgress();
      }
    });

    // å¿«é€Ÿæ¨¡æ¿æ‡‰ç”¨åŠŸèƒ½
    function applyTemplate(templateKey) {
      const template = templates[templateKey];
      if (!template) return;
      
      vibrate([100, 50, 100]);
      
      // æ‡‰ç”¨æ¨¡æ¿è¨­ç½®
      document.getElementById('groupName').value = template.groupName;
      document.getElementById('messageFormat').value = template.messageFormat;
      
      // æ›´æ–°è‡ªå®šç¾©å•é¡Œ
      questions = [...template.customQuestions];
      renderQuestions();
      
      // é¡¯ç¤ºæˆåŠŸé€šçŸ¥
      showNotification(`å·²å¥—ç”¨ã€Œ${template.name}ã€æ¨¡æ¿`, 'success');
      
      // è‡ªå‹•ä¿å­˜
      setTimeout(() => {
        saveSettings.click();
      }, 1000);
    }

    // æ¨¡æ¿å¡ç‰‡é»æ“Šäº‹ä»¶
    document.addEventListener('click', function(e) {
      const templateCard = e.target.closest('[data-template]');
      if (templateCard) {
        const templateKey = templateCard.dataset.template;
        applyTemplate(templateKey);
      }
    });

    // ç§»å‹•ç«¯å¿«æ·æ“ä½œ
    if (isMobile) {
      // å¿«é€Ÿä¿å­˜
      document.getElementById('quickSave').addEventListener('click', () => {
        vibrate([50]);
        saveSettings.click();
      });
      
      // å¿«é€Ÿæ¸¬è©¦
      document.getElementById('quickTest').addEventListener('click', () => {
        vibrate([50]);
        document.getElementById('testConnection').click();
      });
      
      // å¿«é€Ÿæ¨¡æ¿
      document.getElementById('quickTemplate').addEventListener('click', () => {
        vibrate([50]);
        showTemplateModal();
      });
    }

    // æ¨¡æ¿é¸æ“‡å™¨åŠŸèƒ½
    function showTemplateModal() {
      const modal = document.getElementById('templateModal');
      const templateList = document.getElementById('templateList');
      
      // ç”Ÿæˆæ¨¡æ¿åˆ—è¡¨
      templateList.innerHTML = '';
      Object.entries(templates).forEach(([key, template]) => {
        const div = document.createElement('div');
        div.className = 'template-card touch-feedback cursor-pointer';
        div.dataset.template = key;
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-semibold text-white">${template.name}</h4>
              <p class="text-sm opacity-90 text-white">é»æ“Šå¥—ç”¨æ­¤æ¨¡æ¿</p>
            </div>
            <i class="fas fa-arrow-right text-white text-xl"></i>
          </div>
        `;
        templateList.appendChild(div);
      });
      
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function hideTemplateModal() {
      const modal = document.getElementById('templateModal');
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // æ¨¡æ¿é¸æ“‡å™¨äº‹ä»¶
    document.getElementById('closeTemplateModal').addEventListener('click', hideTemplateModal);
    document.getElementById('templateModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideTemplateModal();
      }
    });

    // æ™ºèƒ½è®Šæ•¸æ’å…¥åŠŸèƒ½
    document.addEventListener('click', function(e) {
      if (e.target.hasAttribute('data-variable')) {
        const variable = e.target.dataset.variable;
        const textarea = document.getElementById('messageFormat');
        const cursorPos = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, cursorPos);
        const textAfter = textarea.value.substring(cursorPos);
        
        textarea.value = textBefore + variable + textAfter;
        textarea.focus();
        textarea.setSelectionRange(cursorPos + variable.length, cursorPos + variable.length);
        
        vibrate([30]);
        showNotification(`å·²æ’å…¥è®Šæ•¸ ${variable}`, 'info', 2000);
      }
    });

    // æ ¼å¼é è¦½åŠŸèƒ½
    document.getElementById('previewFormat').addEventListener('click', () => {
      const format = document.getElementById('messageFormat').value;
      const sampleData = {
        date: new Date().toLocaleDateString('zh-HK'),
        item: 'åˆé¤',
        amount: '150.00',
        note: 'èˆ‡å®¢æˆ¶ç”¨é¤',
        imageUrl: 'https://example.com/receipt.jpg'
      };
      
      let preview = format;
      Object.entries(sampleData).forEach(([key, value]) => {
        preview = preview.replace(new RegExp(`{${key}}`, 'g'), value);
      });
      
      showNotification(`é è¦½æ ¼å¼ï¼š\n${preview}`, 'info', 8000);
    });

    // æ ¼å¼åŠ©æ‰‹åŠŸèƒ½
    document.getElementById('formatHelper').addEventListener('click', () => {
      const helpText = `å¯ç”¨è®Šæ•¸ï¼š
ğŸ“… {date} - æ—¥æœŸ
ğŸ’° {item} - é …ç›®åç¨±
ğŸ’µ {amount} - é‡‘é¡
ğŸ“ {note} - å‚™è¨»
ğŸ“¸ {imageUrl} - æ”¶æ“šé€£çµ

ç¯„ä¾‹æ ¼å¼ï¼š
ğŸ¢ å ±éŠ·å–®
ğŸ“… æ—¥æœŸ: {date}
ğŸ’° é …ç›®: {item}
ğŸ’µ é‡‘é¡: ${amount}
ğŸ“ å‚™è¨»: {note}`;
      
      showNotification(helpText, 'info', 10000);
    });

    const qrSection = document.getElementById('qrSection');
    const qrContainer = document.getElementById('qrContainer');
    const qrCode = document.getElementById('qrCode');
    const loadingContainer = document.getElementById('loadingContainer');
    const groupName = document.getElementById('groupName');
    const messageFormat = document.getElementById('messageFormat');
    const driveFolderUrl = document.getElementById('driveFolderUrl');
    const sheetUrl = document.getElementById('sheetUrl');
    const sheetName = document.getElementById('sheetName');
    const companyName = document.getElementById('companyName');
    const customQuestions = document.getElementById('customQuestions');
    const addQuestion = document.getElementById('addQuestion');
    const saveSettings = document.getElementById('saveSettings');
    const logout = document.getElementById('logout');
    const error = document.getElementById('error');

    let questions = [];
    let invoiceFields = [];

          async function checkLoginStatus() {
        try {
          const response = await fetch(`/api/whatsapp/status?userId=${userId}`);
          
          // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç™»å…¥
          if (response.status === 401) {
            showError('æœƒè©±å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
            return;
          }
          
          const data = await response.json();
          
          // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
          if (data.error) {
            showError(data.error);
            if (data.error === 'æœªç™»å…¥') {
              setTimeout(() => {
                window.location.href = '/';
              }, 2000);
            }
            return;
          }
          
          if (data.loggedIn) {
            qrSection.style.display = 'none';
            // å¦‚æœå·²ç¶“é€£æ¥ï¼Œé–‹å§‹ç‹€æ…‹ç›£æ§
            startStatusMonitoring();
          } else {
            qrSection.style.display = 'block';
            loadQRCode();
          }
        } catch (err) {
          showError('æª¢æŸ¥ç™»å…¥ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
          console.error('æª¢æŸ¥ç™»å…¥ç‹€æ…‹éŒ¯èª¤:', err);
        }
      }

    async function loadQRCode() {
      try {
        showProgress();
        document.getElementById('loadingStatus').textContent = 'æ­£åœ¨ç”Ÿæˆ QR ç¢¼...';
        
        const response = await fetch(`/api/whatsapp/qr?userId=${userId}`);
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç™»å…¥
        if (response.status === 401) {
          showNotification('æœƒè©±å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
          return;
        }
        
        const data = await response.json();
        
        // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
        if (data.error) {
          showNotification(data.error, 'error');
          if (data.error === 'æœªç™»å…¥') {
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
          }
          return;
        }
        
        if (data.status === 'alreadyLoggedIn') {
          qrSection.style.display = 'none';
          showNotification('WhatsApp å·²é€£æ¥', 'success');
          document.getElementById('qrStatus').textContent = '(å·²é€£æ¥)';
        } else if (data.qrCodeUrl) {
          loadingContainer.style.display = 'none';
          qrContainer.style.display = 'block';
          qrCode.src = data.qrCodeUrl;
          document.getElementById('qrStatus').textContent = '(ç­‰å¾…æƒæ)';
          startQRTimer();
          pollLoginStatus();
          showNotification('QR ç¢¼å·²ç”Ÿæˆï¼Œè«‹ä½¿ç”¨ WhatsApp æƒæ', 'info');
        } else {
          showNotification('ç„¡æ³•ç”Ÿæˆ QR ç¢¼ï¼Œè«‹ç¨å¾Œé‡è©¦', 'error');
        }
      } catch (err) {
        showNotification('è¼‰å…¥ QR ç¢¼å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦', 'error');
        console.error('è¼‰å…¥ QR ç¢¼éŒ¯èª¤:', err);
      } finally {
        hideProgress();
      }
    }
    
    // QR ç¢¼é‡æ–°ç”ŸæˆåŠŸèƒ½
    document.getElementById('refreshQR').addEventListener('click', () => {
      if (qrTimer) clearInterval(qrTimer);
      loadQRCode();
    });

          async function pollLoginStatus() {
        const interval = setInterval(async () => {
          const response = await fetch(`/api/whatsapp/status?userId=${userId}`);
          const data = await response.json();
          if (data.loggedIn) {
            clearInterval(interval);
            qrSection.style.display = 'none';
            // é–‹å§‹æŒçºŒç›£æ§ç‹€æ…‹è®ŠåŒ–
            startStatusMonitoring();
          }
        }, 5000);
      }

      // WebSocketé€£æ¥ç®¡ç†
      let websocket = null;
      let reconnectAttempts = 0;
      const maxReconnectAttempts = 5;

      function connectWebSocket() {
        try {
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = `${protocol}//${window.location.host}?userId=${userId}`;
          
          websocket = new WebSocket(wsUrl);
          
          websocket.onopen = function(event) {
            console.log('WebSocket é€£æ¥å·²å»ºç«‹');
            reconnectAttempts = 0;
          };
          
          websocket.onmessage = function(event) {
            try {
              const message = JSON.parse(event.data);
              handleWebSocketMessage(message);
            } catch (err) {
              console.error('è§£æ WebSocket æ¶ˆæ¯å¤±æ•—:', err);
            }
          };
          
          websocket.onclose = function(event) {
            console.log('WebSocket é€£æ¥å·²é—œé–‰');
            
            // å˜—è©¦é‡æ–°é€£æ¥
            if (reconnectAttempts < maxReconnectAttempts) {
              reconnectAttempts++;
              console.log(`å˜—è©¦é‡æ–°é€£æ¥ WebSocket (${reconnectAttempts}/${maxReconnectAttempts})`);
              setTimeout(connectWebSocket, 3000 * reconnectAttempts);
            }
          };
          
          websocket.onerror = function(error) {
            console.error('WebSocket éŒ¯èª¤:', error);
          };
          
        } catch (err) {
          console.error('å»ºç«‹ WebSocket é€£æ¥å¤±æ•—:', err);
        }
      }

      function handleWebSocketMessage(message) {
        console.log('æ”¶åˆ° WebSocket æ¶ˆæ¯:', message);
        
        switch (message.type) {
          case 'whatsapp_disconnected':
            console.log('WhatsApp é€£æ¥å·²æ–·é–‹ï¼Œé¡¯ç¤º QR ç¢¼');
            qrSection.style.display = 'block';
            loadingContainer.style.display = 'block';
            qrContainer.style.display = 'none';
            loadQRCode();
            break;
            
          case 'whatsapp_connected':
            console.log('WhatsApp å·²é€£æ¥ï¼Œéš±è— QR ç¢¼');
            qrSection.style.display = 'none';
            break;
            
          case 'qr_code_generated':
            console.log('æ”¶åˆ°æ–°çš„ QR ç¢¼');
            if (message.qrCodeUrl) {
              loadingContainer.style.display = 'none';
              qrContainer.style.display = 'block';
              qrCode.src = message.qrCodeUrl;
            }
            break;
            
          case 'connection':
            console.log('WebSocket é€£æ¥ç¢ºèª:', message);
            break;
            
          default:
            console.log('æœªçŸ¥çš„ WebSocket æ¶ˆæ¯é¡å‹:', message.type);
        }
      }

      // ç§»é™¤èˆŠçš„è¼ªè©¢ç›£æ§ï¼Œæ”¹ç‚ºWebSocketå³æ™‚é€šçŸ¥
      async function startStatusMonitoring() {
        // å•Ÿå‹•WebSocketé€£æ¥
        connectWebSocket();
      }

    async function loadSettings() {
      try {
        const response = await fetch(`/api/settings?userId=${userId}`);
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç™»å…¥
        if (response.status === 401) {
          showError('æœƒè©±å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
          return;
        }
        
        const data = await response.json();
        
        // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
        if (data.error) {
          showError(data.error);
          if (data.error === 'æœªç™»å…¥') {
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
          }
          return;
        }
        
        groupName.value = data.groupName;
        messageFormat.value = data.messageFormat;
        driveFolderUrl.value = data.driveFolderId ? `https://drive.google.com/drive/folders/${data.driveFolderId}` : '';
        sheetUrl.value = data.sheetId ? `https://docs.google.com/spreadsheets/d/${data.sheetId}` : '';
        sheetName.value = data.sheetName;
        companyName.value = data.companyName || '';
        questions = data.customQuestions || [];
        invoiceFields = data.invoiceFields || [
          { label: 'é …ç›®', field: 'item' },
          { label: 'é‡‘é¡', field: 'amount' }
        ];
        
        // è¼‰å…¥ AI è¨­å®š
        const enableAI = document.getElementById('enableAI');
        const aiDot = document.getElementById('aiDot');
        const aiSettings = document.getElementById('aiSettings');
        const aiConfidenceThreshold = document.getElementById('aiConfidenceThreshold');
        const aiConfidenceValue = document.getElementById('aiConfidenceValue');
        
        enableAI.checked = Boolean(data.enableAI);
        aiSettings.style.display = data.enableAI ? 'block' : 'none';
        aiConfidenceThreshold.value = (data.aiConfidenceThreshold || 0.8) * 100;
        aiConfidenceValue.textContent = `${Math.round((data.aiConfidenceThreshold || 0.8) * 100)}%`;
        
        // æ›´æ–° AI é–‹é—œçš„è¦–è¦ºç‹€æ…‹
        updateAIDot();
        
        renderQuestions();
        renderInvoiceFields();
        updatePdfPreview();
      } catch (err) {
        showError('è¼‰å…¥è¨­ç½®å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        console.error('è¼‰å…¥è¨­ç½®éŒ¯èª¤:', err);
      }
    }

    function renderQuestions() {
      customQuestions.innerHTML = '';
      questions.forEach((q, index) => {
        const div = document.createElement('div');
        div.className = 'p-3 sm:p-4 rounded-lg bg-gray-800/20';
        div.innerHTML = `
          <div class="flex flex-col sm:flex-row sm:items-start space-y-2 sm:space-y-0 sm:space-x-4">
            <div class="flex-1 space-y-2">
              <input type="text" value="${q.question}" 
                     class="w-full px-3 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                     placeholder="å•é¡Œ (ä¾‹å¦‚ï¼šè«‹è¼¸å…¥è²»ç”¨é¡åˆ¥)" 
                     onchange="updateQuestion(${index}, 'question', this.value)">
              <input type="text" value="${q.field}" 
                     class="w-full px-3 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                     placeholder="å°æ‡‰çš„æ¬„ä½åç¨± (ä¾‹å¦‚ï¼šcategory)" 
                     onchange="updateQuestion(${index}, 'field', this.value)">
              <input type="text" value="${q.prompts || ''}"
                     class="w-full px-3 py-2 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500 mobile-input"
                     placeholder="æç¤ºè© (å¯é¸, ç”¨é€—è™Ÿåˆ†éš”, å¦‚: äº¤é€š,åˆé¤)"
                     onchange="updateQuestion(${index}, 'prompts', this.value)">
            </div>
            <button onclick="removeQuestion(${index})" 
                    class="px-3 py-2 text-red-400 hover:text-red-300 transition-colors touch-feedback self-end sm:self-center">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        customQuestions.appendChild(div);
      });
    }

    function updateQuestion(index, key, value) {
      questions[index][key] = value;
    }

    function removeQuestion(index) {
      questions.splice(index, 1);
      renderQuestions();
    }

    addQuestion.addEventListener('click', () => {
      questions.push({ question: '', field: '', prompts: '' });
      renderQuestions();
    });

    saveSettings.addEventListener('click', async () => {
      const btn = saveSettings;
      try {
        // æŒ‰éˆ•ç‹€æ…‹ç®¡ç†
        btn.classList.add('loading');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>å„²å­˜ä¸­...';
        showProgress();
        
        const settings = {
          userId,
          groupName: groupName.value,
          messageFormat: messageFormat.value,
          customQuestions: questions,
          driveFolderUrl: driveFolderUrl.value,
          sheetUrl: sheetUrl.value,
          sheetName: sheetName.value,
          companyName: companyName.value,
          invoiceFields: invoiceFields,
          enableAI: document.getElementById('enableAI').checked,
          aiConfidenceThreshold: parseInt(document.getElementById('aiConfidenceThreshold').value) / 100
        };
        
        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          showNotification('è¨­ç½®å·²æˆåŠŸå„²å­˜', 'success');
          
          // é¡¯ç¤ºå„²å­˜ç‹€æ…‹
          const saveStatus = document.getElementById('saveStatus');
          saveStatus.classList.remove('hidden');
          setTimeout(() => saveStatus.classList.add('hidden'), 3000);
          
          // é©—è­‰ç¾¤çµ„åç¨±
          if (groupName.value) {
            document.getElementById('groupNameStatus').classList.remove('hidden');
            setTimeout(() => document.getElementById('groupNameStatus').classList.add('hidden'), 2000);
          }
          
          // æ›´æ–°é€£æ¥ç‹€æ…‹
          setTimeout(updateConnectionStatus, 1000);
          
        } else {
          const data = await response.text();
          showNotification(data || 'å„²å­˜è¨­ç½®å¤±æ•—', 'error');
        }
      } catch (err) {
        showNotification('å„²å­˜è¨­ç½®å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦', 'error');
        console.error('å„²å­˜è¨­ç½®éŒ¯èª¤:', err);
      } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        btn.classList.remove('loading');
        btn.innerHTML = '<i class="fas fa-save mr-2"></i>å„²å­˜è¨­ç½®';
        hideProgress();
      }
    });
    
    // ç‚ºè¼¸å…¥æ¡†æ·»åŠ è‡ªå‹•ä¿å­˜åŠŸèƒ½
    [groupName, messageFormat, driveFolderUrl, sheetUrl, sheetName].forEach(input => {
      input.addEventListener('input', triggerAutoSave);
    });

    logout.addEventListener('click', async () => {
      try {
        const response = await fetch(`/api/logout?userId=${userId}`);
        if (response.ok) {
          window.location.href = '/';
        } else {
          showError('ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦');
        }
      } catch (err) {
        showError('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
        console.error('ç™»å‡ºéŒ¯èª¤:', err);
      }
    });

    function showError(message, color = 'red') {
      const error = document.getElementById('error');
      error.textContent = message;
      error.style.color = color === 'red' ? '#fca5a5' : '#6ee7b7';
      error.style.backgroundColor = color === 'red' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(16, 185, 129, 0.2)';
      error.classList.remove('hidden');
      setTimeout(() => error.classList.add('hidden'), 5000);
    }

    function updateCompanyName(value) {
      fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId,
          companyName: value
        })
      }).then(response => {
        if (!response.ok) {
          throw new Error('æ›´æ–°å¤±æ•—');
        }
        showError('å…¬å¸åç¨±å·²æ›´æ–°', 'green');
      }).catch(err => {
        showError('æ›´æ–°å…¬å¸åç¨±å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
      });
    }

    // åˆ†é åˆ‡æ›åŠŸèƒ½
    const generalTab = document.getElementById('generalTab');
    const analyticsTab = document.getElementById('analyticsTab');
    const pdfTemplateTab = document.getElementById('pdfTemplateTab');
    const generalSettings = document.getElementById('generalSettings');
    const analyticsSettings = document.getElementById('analyticsSettings');
    const pdfTemplateSettings = document.getElementById('pdfTemplateSettings');

    // çµ±ä¸€çš„åˆ†é åˆ‡æ›å‡½æ•¸
    function switchTab(activeTab, activeSettings) {
      // é‡ç½®æ‰€æœ‰åˆ†é æŒ‰éˆ•æ¨£å¼
      [generalTab, analyticsTab, pdfTemplateTab].forEach(tab => {
        if (tab) {
          tab.classList.remove('text-green-400', 'border-green-400');
          tab.classList.add('text-gray-400', 'border-transparent');
        }
      });
      
      // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
      [generalSettings, analyticsSettings, pdfTemplateSettings].forEach(setting => {
        if (setting) {
          setting.classList.add('hidden');
        }
      });
      
      // æ¿€æ´»é¸ä¸­çš„åˆ†é 
      if (activeTab) {
        activeTab.classList.add('text-green-400', 'border-green-400');
        activeTab.classList.remove('text-gray-400', 'border-transparent');
      }
      
      if (activeSettings) {
        activeSettings.classList.remove('hidden');
      }
    }

    // åˆ†é äº‹ä»¶ç›£è½å™¨
    generalTab.addEventListener('click', () => {
      switchTab(generalTab, generalSettings);
    });

    analyticsTab.addEventListener('click', () => {
      switchTab(analyticsTab, analyticsSettings);
    });

    pdfTemplateTab.addEventListener('click', () => {
      switchTab(pdfTemplateTab, pdfTemplateSettings);
    });

    // PDF æ¨¡ç‰ˆç›¸é—œå‡½æ•¸
    function updateCompanyAddress(value) {
      updatePdfTemplate({ companyAddress: value });
    }

    function updateCompanyPhone(value) {
      updatePdfTemplate({ companyPhone: value });
    }

    function updateInvoiceTitle(value) {
      updatePdfTemplate({ invoiceTitle: value });
    }

    function updateInvoiceNumberPrefix(value) {
      updatePdfTemplate({ invoiceNumberPrefix: value });
    }

    function updateInvoiceFooter(value) {
      updatePdfTemplate({ invoiceFooter: value });
    }

    function updatePdfTemplate(settings) {
      fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId,
          ...settings
        })
      }).then(response => {
        if (!response.ok) {
          throw new Error('æ›´æ–°å¤±æ•—');
        }
        showError('è¨­å®šå·²æ›´æ–°', 'green');
        updatePdfPreview();
      }).catch(err => {
        showError('æ›´æ–°è¨­å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
      });
    }

    function updatePdfPreview() {
      const preview = document.getElementById('pdfPreview');
      const companyName = document.getElementById('companyName').value;
      const companyAddress = document.getElementById('companyAddress').value;
      const companyPhone = document.getElementById('companyPhone').value;
      const invoiceTitle = document.getElementById('invoiceTitle').value;
      const invoiceNumberPrefix = document.getElementById('invoiceNumberPrefix').value;
      const invoiceFooter = document.getElementById('invoiceFooter').value;

      // ç”Ÿæˆé è¦½ HTML
      preview.innerHTML = `
        <div class="text-black">
          <div class="text-center mb-8">
            <h1 class="text-2xl font-bold">${invoiceTitle || 'ç™¼ç¥¨'}</h1>
            <p class="text-sm">${invoiceNumberPrefix || 'INV-'}2024001</p>
          </div>
          
          <div class="grid grid-cols-2 gap-4 mb-8">
            <div>
              <h2 class="font-bold mb-2">${companyName || 'å…¬å¸åç¨±'}</h2>
              <p class="text-sm">${companyAddress || 'å…¬å¸åœ°å€'}</p>
              <p class="text-sm">${companyPhone || 'å…¬å¸é›»è©±'}</p>
            </div>
            <div class="text-right">
              <p class="text-sm">æ—¥æœŸï¼š${new Date().toLocaleDateString('zh-HK')}</p>
            </div>
          </div>

          <div class="border-t border-b border-gray-300 py-4 mb-8">
            <table class="w-full">
              <thead>
                <tr>
                  <th class="text-left">é …ç›®</th>
                  <th class="text-right">é‡‘é¡</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>ç¤ºä¾‹é …ç›®</td>
                  <td class="text-right">$1,000.00</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="text-right mb-8">
            <p>ç¸½è¨ˆï¼š$1,000.00</p>
          </div>

          <div class="text-center text-sm">
            ${invoiceFooter || 'è¬è¬æƒ é¡§'}
          </div>
        </div>
      `;
    }

    // ç™¼ç¥¨é …ç›®è¨­å®š
    function renderInvoiceFields() {
      const list = document.getElementById('invoiceFieldsList');
      list.innerHTML = '';
      invoiceFields.forEach((f, idx) => {
        const div = document.createElement('div');
        div.className = 'flex space-x-2 items-center';
        div.innerHTML = `
          <input type="text" value="${f.label}" placeholder="é¡¯ç¤ºåç¨±" class="flex-1 px-2 py-1 rounded bg-gray-800/50 border border-gray-700 text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500" onchange="updateInvoiceField(${idx}, 'label', this.value)">
          <input type="text" value="${f.field}" placeholder="å°æ‡‰æ¬„ä½ (å¦‚: date)" class="flex-1 px-2 py-1 rounded bg-gray-800/50 border border-gray-700 text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-green-500" onchange="updateInvoiceField(${idx}, 'field', this.value)">
          <button onclick="removeInvoiceField(${idx})" class="px-2 py-1 text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
        `;
        list.appendChild(div);
      });
    }
    function updateInvoiceField(idx, key, value) {
      invoiceFields[idx][key] = value;
      saveInvoiceFields();
    }
    function removeInvoiceField(idx) {
      invoiceFields.splice(idx, 1);
      saveInvoiceFields();
      renderInvoiceFields();
    }
    document.getElementById('addInvoiceField').addEventListener('click', () => {
      invoiceFields.push({ label: '', field: '' });
      renderInvoiceFields();
      saveInvoiceFields();
    });
    function saveInvoiceFields() {
      fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, invoiceFields })
      }).then(() => {
        showError('ç™¼ç¥¨æ¬„ä½å·²æ›´æ–°', 'green');
        updatePdfPreview();
      });
    }

    // AI è¨­å®šç›¸é—œå‡½æ•¸
    const enableAI = document.getElementById('enableAI');
    const aiDot = document.getElementById('aiDot');
    const aiSettings = document.getElementById('aiSettings');
    const aiConfidenceThreshold = document.getElementById('aiConfidenceThreshold');
    const aiConfidenceValue = document.getElementById('aiConfidenceValue');

    function updateAIDot() {
      if (enableAI.checked) {
        aiDot.style.transform = 'translateX(24px)';
        aiSettings.style.display = 'block';
      } else {
        aiDot.style.transform = 'translateX(0)';
        aiSettings.style.display = 'none';
      }
    }
    enableAI.addEventListener('change', function() {
      updateAIDot();
      saveSettings.click();
    });
    aiConfidenceThreshold.addEventListener('input', function() {
      aiConfidenceValue.textContent = `${this.value}%`;
      saveSettings.click();
    });
    // åˆå§‹åŒ–æ™‚åŒæ­¥ dot ç‹€æ…‹
    document.addEventListener('DOMContentLoaded', function() {
      updateAIDot();
    });

    // Analytics å„€è¡¨æ¿åŠŸèƒ½
    const openAnalyticsBtn = document.getElementById('openAnalytics');
    if (openAnalyticsBtn) {
      openAnalyticsBtn.addEventListener('click', function() {
        // éœ‡å‹•åé¥‹
        vibrate([50]);
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        showProgress();
        showNotification('æ­£åœ¨å•Ÿå‹• AI æ™ºèƒ½å„€è¡¨æ¿...', 'info', 2000);
        
        // è·³è½‰åˆ° analytics é é¢
        const analyticsUrl = `/analytics?userId=${encodeURIComponent(userId)}`;
        
        // æ·»åŠ ä¸€äº›è¦–è¦ºæ•ˆæœ
        this.classList.add('loading');
        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>è¼‰å…¥ä¸­...';
        
        // å»¶é²è·³è½‰ä»¥é¡¯ç¤ºè¼‰å…¥æ•ˆæœ
        setTimeout(() => {
          window.open(analyticsUrl, '_blank');
          
          // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
          this.classList.remove('loading');
          this.innerHTML = '<i class="fas fa-rocket mr-3"></i>å•Ÿå‹•æ™ºèƒ½å„€è¡¨æ¿';
          hideProgress();
        }, 1000);
      });
    }

    // é é¢åˆå§‹åŒ–
    async function initializePage() {
      try {
        showProgress();
        
        // åˆå§‹ç‹€æ…‹æª¢æŸ¥
        await updateConnectionStatus();
        
        // è¼‰å…¥è¨­ç½®å’Œæª¢æŸ¥ç™»å…¥ç‹€æ…‹
        await Promise.all([
          checkLoginStatus(),
          loadSettings()
        ]);
        
        // è¨­ç½®å®šæœŸç‹€æ…‹æ›´æ–°
        setInterval(updateConnectionStatus, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡ç‹€æ…‹
        
        showNotification('é é¢è¼‰å…¥å®Œæˆ', 'success', 2000);
        
      } catch (error) {
        showNotification('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢', 'error');
        console.error('é é¢åˆå§‹åŒ–éŒ¯èª¤:', error);
      } finally {
        hideProgress();
      }
    }
    
    // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initializePage);
    
    // é é¢å¸è¼‰æ™‚æ¸…ç†è³‡æº
    window.addEventListener('beforeunload', function() {
      if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.close();
      }
      if (qrTimer) clearInterval(qrTimer);
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
    });
    
    // é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚çš„è™•ç†
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        // é é¢é‡æ–°å¯è¦‹æ™‚æ›´æ–°ç‹€æ…‹
        updateConnectionStatus();
      }
    });
  </script>
</body>
</html>