# WhatsApp Bot é‡è¤‡è¨Šæ¯è™•ç†å•é¡Œä¿®å¾©å ±å‘Š

## å•é¡Œæè¿°
ç”¨æˆ¶å ±å‘Šå°è©±æµç¨‹ç•°å¸¸ï¼Œä¸»è¦è¡¨ç¾ç‚ºå°è©±é‡è¤‡è¼¸å‡ºã€‚ç¶“éæ—¥èªŒåˆ†æç™¼ç¾ï¼š

1. **åŒä¸€å€‹è¨Šæ¯IDè¢«å¤šæ¬¡è™•ç†**
   - æ—¥èªŒä¸­é¡¯ç¤ºåŒä¸€å€‹ `msgId` å‡ºç¾å¤šæ¬¡è™•ç†è¨˜éŒ„
   - presence è¨­ç½®è¢«é‡è¤‡åŸ·è¡Œ
   - åŒæ¨£çš„è¨Šæ¯è¢«å¤šæ¬¡æ¨™è¨˜ç‚ºå·²è®€

2. **å…·é«”ç—‡ç‹€**
   ```
   info: æ”¶åˆ°ç”¨æˆ¶çš„è¨Šæ¯ï¼Œé¡å‹ï¼šåª’é«”ï¼ŒIDï¼š3EB0E0AB912BD1025D4969
   info: æ”¶åˆ°ç”¨æˆ¶çš„è¨Šæ¯ï¼Œé¡å‹ï¼šåª’é«”ï¼ŒIDï¼š3EB0E0AB912BD1025D4969  // é‡è¤‡
   ```

3. **æ ¹æœ¬åŸå› **
   - äº‹ä»¶ç›£è½å™¨é‡è¤‡è¨»å†Š
   - ç¼ºä¹æœ‰æ•ˆçš„è¨Šæ¯å»é‡æ©Ÿåˆ¶
   - å®¢æˆ¶ç«¯æ¸…ç†æ™‚æœªæ­£ç¢ºç§»é™¤äº‹ä»¶ç›£è½å™¨

## ä¿®å¾©æ–¹æ¡ˆ

### 1. å¼·åŒ– StateManager è¨Šæ¯å»é‡é‚è¼¯ âœ…

**ä¿®æ”¹æª”æ¡ˆ**: `core/StateManager.js`

- **æ–°å¢è¨Šæ¯è™•ç†ç‹€æ…‹è¿½è¹¤**
  - `markMessageProcessing(msgId)` - æ¨™è¨˜è¨Šæ¯ç‚ºè™•ç†ä¸­
  - `isMessageProcessing(msgId)` - æª¢æŸ¥è¨Šæ¯æ˜¯å¦æ­£åœ¨è™•ç†
  - `completeMessageProcessing(msgId)` - å®Œæˆè¨Šæ¯è™•ç†

- **æ”¹é€²æ™‚é–“æˆ³æ©Ÿåˆ¶**
  - åœ¨è¨Šæ¯è¨˜éŒ„ä¸­åŠ å…¥æ™‚é–“æˆ³ï¼š`msgId + ':' + Date.now()`
  - æ”¯æ´åŸºæ–¼æ™‚é–“çš„è¨˜éŒ„æ¸…ç†å’Œæ’åº

- **å„ªåŒ–è¨˜éŒ„æª¢æŸ¥**
  - ä½¿ç”¨ `startsWith()` æª¢æŸ¥è¨Šæ¯IDå‰ç¶´
  - é˜²æ­¢æ™‚é–“æˆ³å·®ç•°å°è‡´çš„æ¼æª¢

### 2. ä¿®å¾©äº‹ä»¶ç›£è½å™¨é‡è¤‡è¨»å†Š âœ…

**ä¿®æ”¹æª”æ¡ˆ**: `services/whatsappMessage.js`

- **æ·»åŠ ç›£è½å™¨å»é‡é‚è¼¯**
  ```javascript
  // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¨»å†Šéè¨Šæ¯è™•ç†å™¨
  const clientData = clients.get(userId);
  if (clientData && clientData.messageHandler) {
    client.ev.off('messages.upsert', clientData.messageHandler);
    logger.info(`ç”¨æˆ¶ ${userId} çš„èˆŠè¨Šæ¯è™•ç†å™¨å·²ç§»é™¤`);
  }
  ```

- **å¼·åŒ–é‡è¤‡æª¢æŸ¥æ©Ÿåˆ¶**
  ```javascript
  // æª¢æŸ¥æ˜¯å¦å·²è™•ç†æˆ–æ­£åœ¨è™•ç†ä¸­
  if (stateManager.isMessageProcessed(msg.key.id) || 
      stateManager.isMessageSuppressed(msg.key.id) ||
      stateManager.isMessageProcessing(msg.key.id)) {
    logger.debug(`è¨Šæ¯ ${msg.key.id} å·²è™•ç†/å¿½ç•¥/è™•ç†ä¸­ï¼Œè·³éé‡è¤‡è™•ç†`);
    return;
  }
  
  // æ¨™è¨˜ç‚ºè™•ç†ä¸­ï¼Œé˜²æ­¢é‡è¤‡è™•ç†
  stateManager.markMessageProcessing(msg.key.id);
  ```

- **ç¢ºä¿ç‹€æ…‹æ­£ç¢ºæ›´æ–°**
  - åœ¨æ‰€æœ‰è™•ç†åˆ†æ”¯çµå°¾èª¿ç”¨ `stateManager.completeMessageProcessing(msg.key.id)`
  - åŒ…æ‹¬éŒ¯èª¤è™•ç†å’Œç•°å¸¸æƒ…æ³

### 3. æ”¹é€²å®¢æˆ¶ç«¯æ¸…ç†æ©Ÿåˆ¶ âœ…

**ä¿®æ”¹æª”æ¡ˆ**: `services/whatsappConnection.js`

- **å®Œå–„ cleanupClient å‡½æ•¸**
  ```javascript
  async function cleanupClient(userId, client) {
    // ç§»é™¤äº‹ä»¶ç›£è½å™¨ä»¥é˜²æ­¢é‡è¤‡è™•ç†
    const clientData = clients.get(userId);
    if (clientData && clientData.messageHandler && client) {
      try {
        client.ev.off('messages.upsert', clientData.messageHandler);
        logger.info(`ç”¨æˆ¶ ${userId} çš„è¨Šæ¯è™•ç†å™¨å·²ç§»é™¤`);
      } catch (evError) {
        logger.warn(`ç§»é™¤ç”¨æˆ¶ ${userId} çš„è¨Šæ¯è™•ç†å™¨å¤±æ•—ï¼š${evError.message}`);
      }
    }

    // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
    if (client && client.ev) {
      try {
        client.ev.removeAllListeners();
        logger.info(`ç”¨æˆ¶ ${userId} çš„æ‰€æœ‰äº‹ä»¶ç›£è½å™¨å·²ç§»é™¤`);
      } catch (evError) {
        logger.warn(`ç§»é™¤ç”¨æˆ¶ ${userId} çš„äº‹ä»¶ç›£è½å™¨å¤±æ•—ï¼š${evError.message}`);
      }
    }
    // ... å…¶ä»–æ¸…ç†é‚è¼¯
  }
  ```

### 4. å¢å¼·èª¿è©¦å’Œç›£æ§ âœ…

- **æ·»åŠ è©³ç´°æ—¥èªŒ**
  - è¨Šæ¯è™•ç†ç‹€æ…‹è®Šæ›´çš„ debug æ—¥èªŒ
  - äº‹ä»¶ç›£è½å™¨è¨»å†Š/ç§»é™¤çš„ info æ—¥èªŒ
  - é‡è¤‡æª¢æŸ¥çš„è©³ç´°è¨˜éŒ„

- **ç‹€æ…‹çµ±è¨ˆ**
  - è¿½è¹¤è™•ç†ä¸­çš„è¨Šæ¯æ•¸é‡
  - è¨˜éŒ„å·²è™•ç†å’Œå·²å¿½ç•¥çš„è¨Šæ¯çµ±è¨ˆ
  - æä¾›ç‹€æ…‹æ‘˜è¦åŠŸèƒ½

## æ¸¬è©¦é©—è­‰

### æ¸¬è©¦è¦†è“‹ç¯„åœ
1. âœ… StateManager è¨Šæ¯å»é‡é‚è¼¯
2. âœ… è¨Šæ¯è™•ç†æ™‚é–“æˆ³åŠŸèƒ½
3. âœ… WhatsApp è¨Šæ¯è™•ç†å™¨è¨­ç½®
4. âœ… å®¢æˆ¶ç«¯æ¸…ç†åŠŸèƒ½
5. âœ… äº‹ä»¶ç›£è½å™¨å»é‡æ©Ÿåˆ¶

### æ¸¬è©¦çµæœ
```
ğŸ“Š æ¸¬è©¦çµæœç¸½çµ:
âœ… é€šé: 5/5
âŒ å¤±æ•—: 0/5
ğŸ“ˆ æˆåŠŸç‡: 100.0%
```

## é æœŸæ•ˆæœ

### ä¿®å¾©å‰
- åŒä¸€è¨Šæ¯è¢«å¤šæ¬¡è™•ç†
- é‡è¤‡çš„ presence æ›´æ–°
- é‡è¤‡çš„ AI è­˜åˆ¥è«‹æ±‚
- ç”¨æˆ¶æ”¶åˆ°é‡è¤‡éŸ¿æ‡‰

### ä¿®å¾©å¾Œ
- âœ… æ¯å€‹è¨Šæ¯åªè™•ç†ä¸€æ¬¡
- âœ… é«˜æ•ˆçš„å»é‡æ©Ÿåˆ¶
- âœ… æ­£ç¢ºçš„äº‹ä»¶ç›£è½å™¨ç®¡ç†
- âœ… ç©©å®šçš„å®¢æˆ¶ç«¯ç‹€æ…‹

## å½±éŸ¿ç¯„åœ

### æ ¸å¿ƒåŠŸèƒ½
- **è¨Šæ¯è™•ç†æµç¨‹**: å¤§å¹…æ”¹å–„ï¼Œæ¶ˆé™¤é‡è¤‡è™•ç†
- **è³‡æºä½¿ç”¨**: æ¸›å°‘ä¸å¿…è¦çš„ CPU å’Œ API èª¿ç”¨
- **ç”¨æˆ¶é«”é©—**: æ¶ˆé™¤é‡è¤‡éŸ¿æ‡‰ï¼Œæå‡äº’å‹•æµæš¢åº¦

### ç³»çµ±ç©©å®šæ€§
- **è¨˜æ†¶é«”ç®¡ç†**: æ”¹é€²ç‹€æ…‹æ¸…ç†æ©Ÿåˆ¶
- **éŒ¯èª¤è™•ç†**: åŠ å¼·ç•°å¸¸æƒ…æ³çš„è™•ç†
- **æ—¥èªŒè³ªé‡**: æä¾›æ›´è©³ç´°çš„èª¿è©¦ä¿¡æ¯

## éƒ¨ç½²å»ºè­°

1. **é‡æ–°å•Ÿå‹•æœå‹™**: ç¢ºä¿æ–°çš„é‚è¼¯ç”Ÿæ•ˆ
2. **ç›£æ§æ—¥èªŒ**: è§€å¯Ÿ debug æ—¥èªŒç¢ºèªå»é‡æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ
3. **æ¸¬è©¦å°è©±**: ç™¼é€æ¸¬è©¦è¨Šæ¯é©—è­‰ä¸å†å‡ºç¾é‡è¤‡è™•ç†

## ç¶­è­·èªªæ˜

- å®šæœŸåŸ·è¡Œ `stateManager.cleanupOldMessages()` æ¸…ç†èˆŠè¨˜éŒ„
- ç›£æ§ `stateManager.getStats()` ç¢ºä¿ç‹€æ…‹å¥åº·
- å¦‚éœ€èª¿è©¦ï¼Œå¯æŸ¥çœ‹ `stateManager.getStatusSummary()` ç²å–è©³ç´°ç‹€æ…‹

---

**ä¿®å¾©å®Œæˆæ™‚é–“**: 2025-06-24  
**æ¸¬è©¦ç‹€æ…‹**: âœ… å…¨éƒ¨é€šé  
**ç”Ÿç”¢å°±ç·’**: âœ… æ˜¯ 